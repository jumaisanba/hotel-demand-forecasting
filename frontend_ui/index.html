<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Прогнозирование загрузки отеля</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding: 2rem;
            background-color: #f9f9f9;
        }
        .hidden {
            display: none;
        }
        .card {
            width: 70%;
            max-width: 1200px;
            margin: auto;
            box-shadow: 0 0.25rem 1rem rgba(0, 0, 0, 0.05);
        }
        .card-small {
            width: 50%;
            max-width: 800px;
            margin: auto;
            box-shadow: 0 0.25rem 1rem rgba(0, 0, 0, 0.05);
        }
        h3 {
            text-align: center;
        }
    </style>
</head>
<body>

<div class="container">
    <!-- Авторизация -->
    <div id="loginSection" class="card-small p-4 mb-4">
        <h3 class="mb-3">Вход в систему</h3>
        <div class="mb-3">
            <input type="text" id="apiKey" class="form-control" placeholder="Введите API ключ">
        </div>
        <button class="btn btn-primary w-100" onclick="authorize()">Войти</button>
    </div>

    <!-- Главная секция -->
    <div id="mainSection" class="card p-4 hidden">
        <h3 class="mb-4">Прогнозирование cпроса</h3>

        <!-- Загрузка файла -->
        <div class="mb-3">
            <label for="csvFile" class="form-label">Загрузите историю бронирований (CSV):</label>
            <input class="form-control" type="file" id="csvFile" accept=".csv">
<!--            <input class="form-control" type="file" id="csvFile">-->
        </div>
        <button class="btn btn-outline-primary w-100 mb-3" onclick="uploadCSV()">Загрузить</button>

        <!-- Настройки прогноза -->
        <div class="mb-3">
            <label for="forecastDate" class="form-label">Дата, от которой выполняется прогноз:</label>
            <input type="date" id="forecastDate" class="form-control" max="">
        </div>
        <div class="mb-3">
            <label class="form-label">Горизонт прогноза:</label>
            <select id="horizon" class="form-select">
                 <option value="30">1–30 дней</option>
                <option value="7">1–7 дней</option>
                <option value="0">Только история</option>
            </select>
        </div>

        <div class="mb-3">
            <label class="form-label">Наличие депозита:</label>
            <select id="deposit" class="form-select">
                <option value="false">Нет депозита</option>
                <option value="true">Есть депозит</option>
            </select>
        </div>

        <button class="btn btn-primary w-100 mb-3" onclick="fetchForecast()">Получить прогноз</button>

        <!-- Формат вывода -->
        <div class="mb-3">
            <label class="form-label">Формат отображения:</label>
            <select id="displayMode" class="form-select">
                <option value="chart">График</option>
                <option value="table">Таблица</option>
            </select>
        </div>

        <button class="btn btn-primary w-100 mb-4" onclick="renderForecast()">Отобразить</button>

        <!-- Результат -->
        <div id="forecastOutput" class="hidden">
            <div id="forecastWarning" class="alert alert-warning hidden" role="alert"></div>
            <div id="forecastTable" class="hidden"></div>
            <canvas id="forecastChart" class="hidden"></canvas>
            <div id="historySummary" class="mt-3"></div>
        </div>
    </div>
</div>

<!-- Зависимости -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    window.onload = function () {
        const today = new Date().toISOString().split('T')[0];
        const dateInput = document.getElementById("forecastDate");
        dateInput.value = today;
        dateInput.max = today;
    };
    async function authorize() {
        const key = document.getElementById('apiKey').value;
        if (key.trim().length === 0) {
            alert("Введите API ключ.");
            return;
        }

        try {
            const response = await fetch("http://localhost:8001/auth", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ api_key: key })
            });

            if (!response.ok) {
                throw new Error("Ошибка авторизации");
            }

            const data = await response.json();
            localStorage.setItem("access_token", data.access_token);

            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('mainSection').classList.remove('hidden');
        } catch (err) {
            alert("Неверный API ключ или ошибка сервера.");
            console.error(err);
        }
    }

    async function fetchForecast() {
        const token = localStorage.getItem("access_token");
        if (!token) {
            alert("Вы не авторизованы.");
            return;
        }

        const target_date = document.getElementById('forecastDate').value;
        const has_deposit = document.getElementById('deposit').value === 'true';

        const horizonValue = document.getElementById('horizon').value;
        const isHistoryOnly = horizonValue === 'history';
        const horizon = isHistoryOnly ? 0 : parseInt(horizonValue);

        const warningDiv = document.getElementById('forecastWarning');
        const forecastOutput = document.getElementById('forecastOutput');

        warningDiv.classList.add('hidden');
        warningDiv.textContent = '';
        forecastOutput.classList.add('hidden');

        try {
            const response = await fetch("http://localhost:8001/fetch-forecast", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${token}`
                },
               body: JSON.stringify({ target_date, horizon, has_deposit})
            });

            const result = await response.json();

            // Сохраняем данные для дальнейшего использования
            window.forecastData = result.forecast;
            window.historyData = result.history_summary;

            // Отображение предупреждения, если недостаточно истории
            if (result.status === 'insufficient_history') {
                warningDiv.textContent = result.message || "Недостаточно данных.";
                warningDiv.classList.remove('hidden');
                forecastOutput.classList.remove('hidden');
                return;
            }

            // В случае успешного прогноза – просто показать секцию (визуализация отдельно)
            if (result.status === 'ok') {
                forecastOutput.classList.remove('hidden');
                renderForecast()
            }

        } catch (err) {
            warningDiv.textContent = "⚠️ Не удалось получить прогноз: " + err.message;
            warningDiv.classList.remove('hidden');
            forecastOutput.classList.remove('hidden');
            console.error(err);
        }
    }

    async function uploadCSV() {
        const fileInput = document.getElementById("csvFile");
        const file = fileInput.files[0];

        if (!file) {
            alert("Пожалуйста, выберите файл.");
            return;
        }

        const formData = new FormData();
        formData.append("file", file);

        const token = localStorage.getItem("access_token");
        const payload = JSON.parse(atob(token.split('.')[1]));
        const hotel_id = payload.hotel_id;

        try {
            const response = await fetch("http://localhost:8001/upload-bookings", {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${token}`,
                    "X-Hotel-Id": hotel_id
                },
                body: formData
            });

            const result = await response.json();

            if (response.ok) {
                // Обработка ответов сервера по полю `status`
                switch (result.status) {
                    case "ok":
                        alert(`✅ Загружено ${result.added} записей. Пропущено дубликатов: ${result.duplicates_skipped}`);
                        break;
                    case "no_new_records":
                        alert(`ℹ️ Все записи уже были загружены ранее. Пропущено: ${result.duplicates_skipped}`);
                        break;
                    case "no_valid_records":
                        alert(`⚠️ В файле не обнаружено валидных записей.`);
                        break;
                    default:
                        alert("❔ Неизвестный ответ от сервера: " + JSON.stringify(result));
                }
            } else {
                // Обработка ошибок FastAPI
                if (result.detail) {
                    alert("❌ Ошибка: " + result.detail);
                } else {
                    alert("❌ Неизвестная ошибка при загрузке файла.");
                }
            }
        } catch (error) {
            alert("⚠️ Ошибка соединения с сервером: " + error.message);
        }
    }


    function renderForecast() {
        const mode = document.getElementById('displayMode').value;
        const chartCanvas = document.getElementById('forecastChart');
        const tableContainer = document.getElementById('forecastTable');

        chartCanvas.classList.add('hidden');
        tableContainer.classList.add('hidden');

        if (!window.forecastData || !window.historyData) {
            alert("Нет данных для отображения.");
            return;
        }

        if (mode === 'chart') {
            renderForecastChart();
        } else {
            renderForecastTable();
        }
    }

    function renderForecastChart() {
        const chartCanvas = document.getElementById('forecastChart');
        const ctx = chartCanvas.getContext('2d');

        const history = window.historyData;
        const forecast = window.forecastData;

        const combined = [...history.map(d => ({...d, type: 'История'})), ...forecast.map(d => ({...d, type: 'Прогноз'}))];

        const labels = combined.map(d => d.date);
        const bookings = combined.map(d => d.bookings);
        const cancellations = combined.map(d => d.cancellations);
        const adjustedDemand = combined.map(d => d.bookings - d.cancellations);

        const horizonValue = document.getElementById('horizon').value;
        const isHistoryOnly = horizonValue === "0";

        const backgroundBookings = combined.map(d => {
            if (isHistoryOnly) return 'rgba(65,134,243, 0.6)';
            return d.type === 'История' ? 'rgba(65,134,243,0.2)' : 'rgba(65,134,243,0.6)';
        });

        const backgroundCancellations = combined.map(d => {
            if (isHistoryOnly) return 'rgba(255, 99, 132, 0.6)';
            return d.type === 'История' ? 'rgba(255, 99, 132, 0.2)' : 'rgba(255, 99, 132, 0.6)';
        });

        if (window.chartInstance) {
            window.chartInstance.destroy();
        }

        window.chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Бронирования',
                        data: bookings,
                        backgroundColor: backgroundBookings,
                        stack: 'stack1'
                    },
                    {
                        label: 'Отмены',
                        data: cancellations,
                        backgroundColor: backgroundCancellations,
                        stack: 'stack1'
                    },
                    {
                        label: 'Скорректированный спрос',
                        data: adjustedDemand,
                        type: 'line',
                        borderColor: 'black',
                        borderWidth: 2,
                        pointRadius: 2,
                        tension: 0.2,
                        fill: false,
                        order: 99
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        stacked: true,
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Количество'
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                }
            }
        });

        chartCanvas.classList.remove('hidden');
    }

    function renderForecastTable() {
        const tableContainer = document.getElementById('forecastTable');
        const history = window.historyData;
        const forecast = window.forecastData;

        const combined = [...history.map(d => ({...d, type: 'История'})), ...forecast.map(d => ({...d, type: 'Прогноз'}))];

        const rows = combined.map(d => {
            const net = d.bookings - d.cancellations;
            return `<tr>
                <td>${d.date}</td>
                <td>${d.type}</td>
                <td>${d.bookings}</td>
                <td>${d.cancellations}</td>
                <td>${net}</td>
            </tr>`;
        }).join('');

        tableContainer.innerHTML = `
            <table class="table table-striped table-bordered">
                <thead class="table-light">
                    <tr>
                        <th>Дата</th>
                        <th>Источник</th>
                        <th>Бронирования</th>
                        <th>Отмены</th>
                        <th>Скорректированный спрос</th>
                    </tr>
                </thead>
                <tbody>
                    ${rows}
                </tbody>
            </table>
        `;

        tableContainer.classList.remove('hidden');
    }
</script>
</body>
</html>